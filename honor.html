<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â≠∏Ê†°Ê¶ÆË≠ΩÊ¶ú</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Iansui&display=swap" rel="stylesheet">

    <style>
        /* --- Âü∫Á§éË®≠ÂÆö --- */
        :root {
            --bg-color: transparent; 
            --text-color: #222222;
            --link-color: #0044cc;
            --focus-outline: 0.25rem solid #ffcc00;
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --badge-bg: #fff9c4; 
            --badge-text: #8d6e63;
            --tag-bg-dept: #f0f0f0;
            --main-font: "Iansui", "Microsoft JhengHei", "Heiti TC", sans-serif;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--main-font);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
            margin: 0; padding: 0;
            font-size: 1rem;
            width: 100%; overflow-x: hidden;
        }

        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        .container { width: 100%; max-width: 100vw; margin: 0; padding: 0 5px; }

        /* --- ÂàÜÈ°ûÁØ©ÈÅ∏ÊåâÈàï --- */
        .filter-section {
            display: flex; flex-wrap: wrap; gap: 6px;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px dashed #ccc;
        }
        
        .filter-btn {
            background-color: #fff;
            border: 2px solid var(--btn-color, #333); 
            color: var(--btn-color, #333);
            padding: 4px 10px; 
            font-size: 0.95rem; 
            border-radius: 4px;
            cursor: pointer; 
            transition: all 0.2s;
            font-family: inherit;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover { background-color: rgba(0,0,0,0.05); }

        .filter-btn.active {
            background-color: var(--btn-color, #333);
            color: #fff;
        }

        .count-badge {
            background-color: #eee; color: #555; 
            font-size: 0.85em; padding: 1px 6px; border-radius: 4px; 
            min-width: 20px; text-align: center;
        }
        
        .filter-btn.active .count-badge {
            color: #333; background-color: rgba(255,255,255,0.8);
        }

        /* --- ÂàóË°®Ê®£Âºè --- */
        .honor-list { list-style: none; padding: 0; margin: 0; width: 100%; }
        
        .honor-item { 
            display: flex; gap: 20px; 
            padding: 20px 0; 
            border-bottom: 1px solid #eee; width: 100%; 
        }
        
        /* ÂúñÁâáÂçÄ */
        .honor-img-box { 
            flex-shrink: 0; 
            width: 220px; height: 155px; 
            position: relative; 
        }
        
        .honor-img-box button { width: 100%; height: 100%; padding: 0; border: none; background: none; cursor: pointer; }
        .honor-thumb { width: 100%; height: 100%; object-fit: cover; border: 1px solid #ddd; padding: 3px; background: #fff; display: block; }
        
        /* ÂÖßÂÆπÂçÄ */
        .honor-content-box { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        
        .honor-title-row { margin-bottom: 8px; }
        .title-btn {
            background: none; border: none; padding: 0; font-size: 1.25rem; 
            color: #333; text-align: left; cursor: pointer; font-family: inherit;
            line-height: 1.4; text-decoration: none; font-weight: bold;
        }
        .title-btn:hover { color: var(--link-color); text-decoration: underline; }
        
        /* ÂÖßÂÆπÊà™Êñ∑ */
        .honor-desc { 
            font-size: 1rem; color: #555; line-height: 1.6; margin-bottom: 8px; 
            white-space: pre-wrap; word-break: break-word; 
        }
        .desc-truncated { 
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; 
        }
        .show-more-btn { 
            color: var(--link-color); cursor: pointer; font-size: 0.95rem; 
            background: none; border: none; padding: 0; font-family: inherit; 
            text-align: left; display: inline-block; margin-bottom: 10px;
        }
        .show-more-btn:hover { text-decoration: underline; }
        
        /* Â∫ïÈÉ®Ë≥áË®äÂàó */
        .honor-meta { margin-top: auto; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 0.9rem; color: #666; }
        
        /* Ê®ôÁ±§Ê®£Âºè */
        .tag-badge { 
            padding: 0.2rem 0.5rem; border-radius: 4px; 
            font-size: 0.85rem; white-space: nowrap; 
            display: inline-block; cursor: default; 
        }
        .tag-dept { background-color: var(--tag-bg-dept); color: #333; }

        /* ÂàÜÈ†Å */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 25px; margin-bottom: 20px; flex-wrap: wrap; }
        .page-btn { padding: 8px 12px; border: 1px solid #ddd; background: #fff; color: var(--link-color); cursor: pointer; text-decoration: none; font-size: 1rem; border-radius: 4px; min-width: 35px; font-family: inherit; }
        .page-btn:hover { background-color: #eee; }
        .page-btn.active { background-color: var(--link-color); color: #fff; border-color: var(--link-color); }
        .page-btn:disabled { color: #ccc; cursor: not-allowed; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: #fff; width: 95%; max-width: 60rem; max-height: 90vh; overflow-y: auto; padding: 2rem; border-radius: 4px; position: relative; border: 2px solid #000; }
        
        .close-btn { 
            position: absolute; top: 15px; right: 15px; 
            background: #d32f2f; color: #fff; border: none; 
            width: 32px; height: 32px; border-radius: 4px; 
            font-size: 1.5rem; padding: 0; text-align: center; 
            cursor: pointer; font-family: Arial, sans-serif; 
            transition: background 0.2s; 
            display: flex; align-items: center; justify-content: center; line-height: 1; 
            z-index: 10;
        }
        .close-btn:hover { background: #b71c1c; }

        /* Ê®ôÈ°åÂàó */
        .modal-header-row { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;
            padding-right: 40px; 
        }
        
        .honor-badge { display: inline-flex; align-items: center; gap: 5px; background-color: var(--badge-bg); color: var(--badge-text); padding: 6px 12px; border-radius: 4px; font-weight: bold; font-size: 1rem; }
        .badge-icon { width: 18px; height: 18px; fill: currentColor; }
        
        .modal-title-text { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; line-height: 1.4; }
        .modal-body-text { font-size: 1.1rem; line-height: 1.8; color: #333; white-space: pre-wrap; margin-bottom: 30px; }
        
        .photo-list { list-style: none; padding: 0; margin: 15px 0 0 0; display: flex; flex-wrap: wrap; gap: 15px; }
        .photo-item img { height: 150px; width: auto; max-width: 100%; border: 1px solid #ddd; padding: 3px; object-fit: contain; background: #fff; transition: transform 0.2s; }
        .photo-item img:hover { transform: scale(1.05); border-color: var(--link-color); cursor: pointer; }

        #loading { font-size: 1rem; color: #666; padding: 20px; text-align: center; }

        @media (max-width: 768px) {
            .honor-item { flex-direction: column; }
            .honor-img-box { width: 100%; height: auto; aspect-ratio: 4 / 3; margin-bottom: 10px; }
            .honor-thumb { width: 100%; height: 100%; object-fit: cover; object-position: center top; }
            .modal-content { padding: 1rem; }
            .modal-header-row { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="sr-only">Â≠∏Ê†°Ê¶ÆË≠ΩÊ¶úÂàóË°®</h1>
    <div id="loading" role="status">‚Üª Ê¶ÆË≠ΩÊ¶úËºâÂÖ•‰∏≠...</div>
    
    <nav id="filter-section" class="filter-section" aria-label="Ê¶ÆË≠ΩÊ¶úÂàÜÈ°ûÁØ©ÈÅ∏">
        <button class="filter-btn active" data-cat="all" style="--btn-color: #337ab7;">ÂÖ®ÈÉ®Ê¶ÆË≠Ω</button>
    </nav>
    
    <ul id="honor-list" class="honor-list" aria-live="polite"></ul>
    
    <nav aria-label="ÂàÜÈ†ÅÂ∞éËà™">
        <div id="pagination" class="pagination"></div>
    </nav>
</div>

<div id="detail-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title-text">
    <div class="modal-content">
        <button id="modal-close-btn" class="close-btn" title="ÈóúÈñâ">&times;</button>

        <div class="modal-header-row">
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <span class="honor-badge">
                    <svg class="badge-icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                    Ê¶ÆË≠ΩÊ¶ú
                </span>
                <div style="color:#666; font-size:0.95rem;">
                    <span id="modal-dept"></span> | <span id="modal-date"></span>
                </div>
            </div>
        </div>

        <h2 id="modal-title-text" class="modal-title-text">ÂÖ¨ÂëäË©≥Á¥∞ÂÖßÂÆπ</h2>
        
        <div id="modal-body-text" class="modal-body-text"></div>

        <div id="modal-photos" style="display:none; margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px;">
            <h3 style="font-size:1rem; margin:0 0 10px 0; color:#555;">üì∏ Á´∂Ë≥ΩÁÖßÁâá</h3>
            <ul id="photo-list" class="photo-list"></ul>
        </div>
    </div>
</div>

<script>
    // ‚òÖ Ë´ãÁ¢∫Ë™çÊÇ®ÁöÑ Ê¶ÆË≠ΩÊ¶ú GAS Á∂≤ÂùÄ ‚òÖ
    const DATA_URL = "https://script.google.com/macros/s/AKfycbxlLrGfUegvnoHz7fyBSiytGI9LHF8e7NN9t9grpGV1j0hcRNhkLnMh4lLLRFAzFdv-9Q/exec"; 
    const ITEMS_PER_PAGE = 3; 

    // È†êË®≠ÂúñÁâá
    const DEFAULT_IMAGES = [
        "https://esa.ntpc.edu.tw/web-heromgt/images/default_1.jpg",
        "https://esa.ntpc.edu.tw/web-heromgt/images/default_2.jpg",
        "https://esa.ntpc.edu.tw/web-heromgt/images/default_3.jpg",
        "https://esa.ntpc.edu.tw/web-heromgt/images/default_4.jpg",
        "https://esa.ntpc.edu.tw/web-heromgt/images/default_5.jpg"
    ];

    const HONOR_CAT_CONFIG = {
        "all": { name: "ÂÖ®ÈÉ®", color: "#337ab7" },
        "10": { name: "ÂúãÈöõ", color: "#f39c12" },
        "20": { name: "ÂÖ®Âúã", color: "#00c0ef" },
        "40": { name: "Á∏£Â∏Ç", color: "#9358ac" },
        "50": { name: "ÂçÄÂüü", color: "#e91e63" },
        "60": { name: "ÂÖ®Ê†°", color: "#8dc153" },
        "70": { name: "Âπ¥Á¥ö", color: "#00a65a" },
        "99": { name: "Ê∞ëÈñì", color: "#e67e22" }
    };

    const HONOR_CAT_ORDER = ["all", "10", "20", "40", "50", "60", "70", "99"];

    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let currentCategory = 'all';
    let lastFocusedElement = null;

    const listContainer = document.getElementById('honor-list');
    const loadingDiv = document.getElementById('loading');
    const paginationDiv = document.getElementById('pagination');
    const filterSection = document.getElementById('filter-section');

    const modal = document.getElementById('detail-modal');
    const modalTitleText = document.getElementById('modal-title-text');
    const modalDate = document.getElementById('modal-date');
    const modalDept = document.getElementById('modal-dept');
    const modalBodyText = document.getElementById('modal-body-text');
    const modalPhotos = document.getElementById('modal-photos');
    const photoList = document.getElementById('photo-list');
    const closeBtn = document.getElementById('modal-close-btn');

    fetch(DATA_URL)
        .then(res => res.json())
        .then(json => {
            loadingDiv.style.display = 'none';
            if (json.status !== "success" || !json.data || json.data.length === 0) {
                listContainer.innerHTML = "<div style='text-align:center; padding:20px'>ÁõÆÂâçÊ≤íÊúâÊ¶ÆË≠ΩÊ¶úË≥áÊñô„ÄÇ</div>";
                return;
            }
            allData = json.data;
            filteredData = allData;
            
            initFilters();
            renderPage(1);
        })
        .catch(err => {
            console.error(err);
            loadingDiv.innerHTML = "<span style='color:red;'>ËºâÂÖ•Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ</span>";
        });

    function initFilters() {
        const counts = { "all": allData.length };
        allData.forEach(item => {
            if (item.category_id) counts[item.category_id] = (counts[item.category_id] || 0) + 1;
        });

        filterSection.innerHTML = "";

        HONOR_CAT_ORDER.forEach(catId => {
            if (HONOR_CAT_CONFIG[catId]) {
                createFilterBtn(catId, counts[catId] || 0);
            }
        });
    }

    function createFilterBtn(catId, count) {
        const config = HONOR_CAT_CONFIG[catId] || { name: "ÂÖ∂‰ªñ", color: "#999" };
        const btn = document.createElement('button');
        btn.className = `filter-btn ${catId === 'all' ? 'active' : ''}`;
        btn.style.setProperty('--btn-color', config.color);
        
        // ‚òÖ ‰øÆÊîπÔºötitle Âä†ÂÖ•Êï∏ÈáèÊèêÁ§∫ ‚òÖ
        btn.title = `ÁØ©ÈÅ∏ÂàÜÈ°ûÔºö${config.name}ÔºåÂÖ± ${count} Ââá`; 
        
        btn.dataset.id = catId;
        btn.innerHTML = `${config.name} <span class="count-badge">${count}</span>`;
        
        btn.onclick = () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            applyFilter(catId);
        };
        filterSection.appendChild(btn);
    }

    function applyFilter(catId) {
        currentCategory = catId;
        if (catId === 'all') {
            filteredData = allData;
        } else {
            filteredData = allData.filter(item => item.category_id == catId);
        }
        currentPage = 1;
        renderPage(1);
    }

    function renderPage(page) {
        currentPage = page;
        listContainer.innerHTML = "";
        
        if (filteredData.length === 0) {
            listContainer.innerHTML = "<div style='text-align:center; padding:20px; color:#666;'>Ê≠§ÂàÜÈ°ûÁÑ°Ë≥áÊñô</div>";
            paginationDiv.innerHTML = "";
            return;
        }

        const start = (page - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const pageItems = filteredData.slice(start, end);

        pageItems.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'honor-item';
            
            const d = item.date;
            const dateStr = d ? (d.length === 8 ? `${d.substring(0,4)}-${d.substring(4,6)}-${d.substring(6,8)}` : d) : '';
            const catConfig = HONOR_CAT_CONFIG[item.category_id] || { name: item.category_name || "Ê¶ÆË≠Ω", color: "#999" };
            
            let imgSrc = '';
            
            if (item.images && item.images.length > 0) {
                imgSrc = item.images[0].url; 
            } else {
                const idNum = parseInt(item.id, 10) || 0; 
                const defaultIndex = idNum % 5; 
                imgSrc = DEFAULT_IMAGES[defaultIndex];
            }

            const imgHtml = `
                <div class="honor-img-box">
                    <button onclick="openDetails(${start + index})" title="Êü•ÁúãË©≥ÊÉÖÔºö${item.title}">
                        <img src="${imgSrc}" class="honor-thumb" alt="${item.title} ÁöÑÁ´∂Ë≥ΩÁÖßÁâá">
                    </button>
                </div>`;

            const contentId = `desc-${item.id}`;
            const btnId = `btn-${item.id}`;
            const maxChars = 70; 

            let descHtml = '';
            let moreBtnHtml = '';

            if (item.content && item.content.length > maxChars) {
                descHtml = `<div id="${contentId}" class="honor-desc desc-truncated">${item.content}</div>`;
                moreBtnHtml = `<button id="${btnId}" class="show-more-btn" onclick="toggleMore('${contentId}', '${btnId}')" title="Â±ïÈñãÊõ¥Â§öÂÖßÂÆπ">È°ØÁ§∫Êõ¥Â§öÂÖßÂÆπ...</button>`;
            } else {
                descHtml = `<div class="honor-desc">${item.content || ''}</div>`;
            }

            li.innerHTML = `
                ${imgHtml}
                <div class="honor-content-box">
                    <div class="honor-title-row">
                        <button class="title-btn" onclick="openDetails(${start + index})" title="Êü•ÁúãË©≥ÊÉÖÔºö${item.title}">
                            ${item.title}
                        </button>
                    </div>
                    
                    ${descHtml}
                    ${moreBtnHtml}
                    
                    <div class="honor-meta">
                        <span class="tag-badge" style="background-color:${catConfig.color}; color:#fff;" title="ÂàÜÈ°ûÔºö${catConfig.name}">
                            <span class="sr-only">ÂàÜÈ°ûÔºö</span>${catConfig.name}
                        </span>
                        <span class="tag-badge tag-dept" title="ÁôºÂ∏ÉÂñÆ‰ΩçÔºö${item.dept}">
                            <span class="sr-only">ÁôºÂ∏ÉÂñÆ‰ΩçÔºö</span>${item.dept}
                        </span>
                        <span style="margin-left:auto;">${dateStr}</span>
                    </div>
                </div>
            `;
            listContainer.appendChild(li);
        });

        renderPagination();
        window.scrollTo(0, 0);
    }

    window.toggleMore = function(contentId, btnId) {
        const content = document.getElementById(contentId);
        const btn = document.getElementById(btnId);
        if (content.classList.contains('desc-truncated')) {
            content.classList.remove('desc-truncated');
            btn.style.display = 'none';
        }
    };

    window.openDetails = function(index) {
        const item = filteredData[index];
        lastFocusedElement = document.activeElement;
        
        modalTitleText.textContent = item.title;
        modalBodyText.textContent = item.content;
        
        const d = item.date;
        const dateStr = d ? (d.length === 8 ? `${d.substring(0,4)}-${d.substring(4,6)}-${d.substring(6,8)}` : d) : '';
        modalDate.textContent = dateStr;
        modalDept.textContent = item.dept;

        if (item.images && item.images.length > 0) {
            modalPhotos.style.display = 'block';
            photoList.innerHTML = item.images.map(img => `
                <li class="photo-item">
                    <a href="${img.url}" target="_blank" download title="‰∏ãËºâÂéüÂúñÔºö${item.title}">
                        <img src="${img.url}" alt="Á´∂Ë≥ΩÁÖßÁâáÔºö${item.title}">
                    </a>
                </li>
            `).join('');
        } else {
            modalPhotos.style.display = 'none';
        }

        modal.style.display = 'flex';
        closeBtn.focus(); 
        document.body.style.overflow = 'hidden'; 
    };

    function closeModal() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        if (lastFocusedElement) lastFocusedElement.focus();
    }

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.style.display === 'flex') closeModal(); });

    function renderPagination() {
        paginationDiv.innerHTML = "";
        const totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
        
        if (totalPages <= 1) return;

        const pagesPerGroup = 10;
        const currentGroup = Math.ceil(currentPage / pagesPerGroup);
        const startPage = (currentGroup - 1) * pagesPerGroup + 1;
        const endPage = Math.min(startPage + pagesPerGroup - 1, totalPages);

        if (startPage > 1) {
             const prevGroupBtn = document.createElement('button');
             prevGroupBtn.className = 'page-btn';
             prevGroupBtn.innerText = "<<"; 
             prevGroupBtn.title = "‰∏ä10È†Å";
             prevGroupBtn.onclick = () => renderPage(startPage - 1); 
             paginationDiv.appendChild(prevGroupBtn);
        }

        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.innerText = "<";
        prevBtn.title = "‰∏ä‰∏ÄÈ†Å";
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => renderPage(currentPage - 1);
        paginationDiv.appendChild(prevBtn);

        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            btn.innerText = i;
            btn.title = `ÂâçÂæÄÁ¨¨ ${i} È†Å`;
            if(i === currentPage) btn.setAttribute('aria-current', 'page');
            btn.onclick = () => renderPage(i);
            paginationDiv.appendChild(btn);
        }

        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.innerText = ">";
        nextBtn.title = "‰∏ã‰∏ÄÈ†Å";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => renderPage(currentPage + 1);
        paginationDiv.appendChild(nextBtn);

        if (endPage < totalPages) {
             const nextGroupBtn = document.createElement('button');
             nextGroupBtn.className = 'page-btn';
             nextGroupBtn.innerText = ">>"; 
             nextGroupBtn.title = "‰∏ã10È†Å";
             nextGroupBtn.onclick = () => renderPage(endPage + 1); 
             paginationDiv.appendChild(nextGroupBtn);
        }
    }
</script>

</body>
</html>