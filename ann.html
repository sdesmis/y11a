<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸æ ¡å…¬å‘Š</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Iansui&display=swap" rel="stylesheet">

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        :root {
            --bg-color: transparent; 
            --text-color: #222222;
            --link-color: #0044cc;
            --focus-outline: 0.25rem solid #ffcc00;
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --btn-active-bg: #0044cc;
            --btn-active-text: #ffffff;
            --tag-bg-dept: #f0f0f0; 
            --main-font: "Iansui", "Microsoft JhengHei", "Heiti TC", sans-serif;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--main-font);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
            margin: 0; padding: 0;
            font-size: 1rem;
            width: 100%; overflow-x: hidden;
        }

        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        .container { width: 100%; max-width: 100vw; margin: 0; padding: 0 5px; }

        /* SVG åœ–ç¤º */
        .icon-svg { display: inline-block; vertical-align: text-bottom; }
        .icon-top { color: #d32f2f; margin-right: 4px; width: 18px; height: 18px; }
        .icon-new { margin-left: 6px; height: 18px; vertical-align: middle; }

        /* --- ä¸Šæ–¹æ“ä½œå€ (åˆ†é¡ + æœå°‹éˆ•) --- */
        .toolbar-section {
            display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between;
            gap: 10px; margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 10px;
        }
        
        .filter-group { display: flex; flex-wrap: wrap; gap: 6px; flex-grow: 1; }

        .filter-btn {
            background-color: #fff;
            border: 2px solid var(--btn-color, #333);
            color: var(--btn-color, #333);
            padding: 4px 10px; 
            font-size: 0.95rem; 
            border-radius: 4px;
            cursor: pointer; 
            transition: all 0.2s;
            font-family: inherit;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover { background-color: rgba(0,0,0,0.05); }

        .filter-btn.active {
            background-color: var(--btn-color, #333);
            color: #fff;
        }

        .count-badge {
            background-color: #eee; color: #555; 
            font-size: 0.85em; padding: 1px 6px; border-radius: 4px; 
            min-width: 20px; text-align: center;
        }
        
        .filter-btn.active .count-badge {
            color: #333; background-color: rgba(255,255,255,0.8);
        }

        /* æŒ‰éˆ•é¡è‰²åŠ æ·± (AAA å°æ¯”åº¦) */
        .search-toggle-btn {
            background-color: #005A8C; 
            color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;
            font-size: 1rem; font-family: inherit; display: flex; align-items: center; gap: 5px;
            transition: background 0.2s; font-weight: bold;
        }
        .search-toggle-btn:hover { background-color: #003F63; }

        /* --- æœå°‹é¢æ¿ --- */
        .search-panel {
            background-color: #f2f2f2; border: 1px solid #ddd; border-radius: 4px;
            padding: 15px; margin-bottom: 20px; display: none;
        }
        .search-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 10px; align-items: center; }
        .search-item { display: flex; align-items: center; gap: 5px; }
        .search-item label { font-weight: bold; color: #333; white-space: nowrap; }
        .form-control {
            padding: 6px 8px; border: 1px solid #777; 
            border-radius: 4px; font-size: 0.95rem; font-family: inherit; color: #222;
        }
        
        .btn-submit { 
            background-color: #A30000; 
            color: #fff; border: none; padding: 6px 15px; border-radius: 4px; 
            cursor: pointer; font-family: inherit; font-weight: bold;
        }
        .btn-submit:hover { background-color: #7A0000; }
        
        .btn-reset { 
            background-color: #fff; color: #222; border: 2px solid #555; 
            padding: 4px 15px; border-radius: 4px; cursor: pointer; 
            font-family: inherit; font-weight: bold;
        }
        .btn-reset:hover { background-color: #e6e6e6; }

        /* --- åˆ—è¡¨æ¨£å¼ --- */
        .announcement-list { list-style: none; padding: 0; margin: 0; }
        .list-item { border-bottom: 1px solid #eee; padding: 0.6rem 0.4rem; display: flex; align-items: center; gap: 0.8rem; }
        .list-item:hover { background-color: rgba(0,0,0,0.03); }
        .list-date { font-family: var(--main-font); font-size: 1rem; color: #555; flex-shrink: 0; width: 11ch; }
        .list-tags { display: flex; gap: 4px; flex-wrap: wrap; min-width: 80px; max-width: 25%; }
        
        .tag-badge { padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.9rem; white-space: nowrap; display: inline-block; cursor: default; }
        .tag-dept { background-color: #f0f0f0; color: #333; }

        .login-badge { background-color: #555; color: #fff; padding: 1px 8px; border-radius: 4px; font-size: 0.9rem; margin-left: 8px; text-decoration: none; display: inline-block; vertical-align: middle; transition: background-color 0.2s; cursor: pointer; border: 1px solid #333; }
        .login-badge:hover { background-color: #333; }

        .list-title { flex-grow: 1; min-width: 0; }
        .title-btn { background: none; border: none; padding: 0; font-size: 1.1rem; color: var(--link-color); text-decoration: none; cursor: pointer; text-align: left; font-weight: normal; font-family: inherit; line-height: 1.5; display: inline-block; word-wrap: break-word; }
        .title-btn:hover { color: #002266; text-decoration: underline; }
        .title-btn:focus { outline: var(--focus-outline); background-color: #000; color: #ffcc00; }

        /* åˆ†é  */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 1.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .page-btn { padding: 8px 12px; border: 1px solid #777; background: #fff; color: var(--link-color); cursor: pointer; text-decoration: none; font-size: 1rem; border-radius: 4px; min-width: 35px; font-family: inherit; font-weight: bold; }
        .page-btn:hover { background-color: #eee; }
        .page-btn.active { background-color: var(--link-color); color: #fff; border-color: var(--link-color); }
        .page-btn:disabled { color: #777; cursor: not-allowed; background-color: #eee;}

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: #fff; width: 90%; max-width: 70ch; max-height: 90vh; overflow-y: auto; padding: 1.5rem; border: 2px solid #000; border-radius: 0.5rem; position: relative; }
        .modal-body { white-space: pre-wrap; line-height: 1.8; font-size: 1.05rem; }
        .modal-body * { color: #000 !important; background: transparent !important; font-size: inherit !important; font-family: inherit !important; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: #d32f2f; color: #fff; border: none; width: 32px; height: 32px; border-radius: 4px; font-size: 1.5rem; padding: 0; text-align: center; cursor: pointer; font-family: Arial, sans-serif; transition: background 0.2s; display: flex; align-items: center; justify-content: center; line-height: 1; }
        .close-btn:hover { background: #b71c1c; }
        .attachments-area { background: #f4f4f4; padding: 1rem; border: 1px dashed #666; margin-top: 1rem; }
        .attachments-area h3 { margin: 0 0 0.5rem 0; font-size: 1rem; color: #333; }
        .attachments-area a { color: var(--link-color); font-weight: bold; display: inline-block; padding: 0.3rem; }
        #loading { font-size: 1rem; color: #666; padding: 1rem; text-align: center; }

        @media (max-width: 700px) {
            .list-item { flex-direction: column; align-items: flex-start; gap: 0.3rem; }
            .list-date { width: auto; font-size: 0.9rem; display: inline-block; margin-right: 10px;}
            .list-tags { max-width: 100%; margin-bottom: 4px; } 
            .modal-content { width: 95%; padding: 1.5rem 1rem; }
            .login-badge { margin-left: 0; margin-top: 5px; display: inline-block; }
            .search-row { flex-direction: column; align-items: stretch; gap: 10px; }
            .search-item { flex-direction: column; align-items: flex-start; }
            .form-control { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="loading" role="status">â†» å…¬å‘Šè¼‰å…¥ä¸­...</div>
    
    <div id="toolbar" class="toolbar-section">
        <nav id="filter-group" class="filter-group" aria-label="å…¬å‘Šåˆ†é¡å¿«é€Ÿç¯©é¸">
            <span class="sr-only">è¼‰å…¥åˆ†é¡ä¸­...</span>
        </nav>
        
        <button id="toggle-search-btn" class="search-toggle-btn" title="é–‹å•Ÿæˆ–é—œé–‰è³‡æ–™æª¢ç´¢é¢æ¿" aria-expanded="false" aria-controls="search-panel">
            <svg aria-hidden="true" focusable="false" style="width:16px;height:16px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            è³‡æ–™æª¢ç´¢
        </button>
    </div>

    <div id="search-panel" class="search-panel" role="region" aria-label="è¤‡åˆæŸ¥è©¢å€å¡Š">
        <div class="search-row">
            <div class="search-item">
                <label for="search-start">å…¬å‘Šæ—¥æœŸï¼š</label>
                <input type="date" id="search-start" class="form-control" title="æœå°‹èµ·æ—¥">
                
                <label for="search-end" class="sr-only">è‡³ (è«‹è¼¸å…¥è¿„æ—¥)</label>
                <span aria-hidden="true" style="margin: 0 5px; color: #333;">è‡³</span>
                <input type="date" id="search-end" class="form-control" title="æœå°‹è¿„æ—¥">
            </div>
            <div class="search-item">
                <label for="search-cat">é¡åˆ¥ï¼š</label>
                <select id="search-cat" class="form-control">
                    <option value="">å…¨éƒ¨é¡åˆ¥</option>
                </select>
            </div>
        </div>
        <div class="search-row">
            <div class="search-item" style="flex-grow: 1;">
                <label for="search-dept">å…¬å‘Šè™•å®¤ï¼š</label>
                <select id="search-dept" class="form-control">
                    <option value="">å…¨éƒ¨è™•å®¤</option>
                </select>
            </div>
            <div class="search-item" style="flex-grow: 2;">
                <label for="search-keyword">é—œéµå­—ï¼š</label>
                <input type="text" id="search-keyword" class="form-control" placeholder="è«‹è¼¸å…¥æ¨™é¡Œæˆ–å…§å®¹é—œéµå­—">
            </div>
            <div class="search-item">
                <button id="btn-search" class="btn-submit"><span aria-hidden="true">ğŸ”</span> è¤‡åˆæŸ¥è©¢</button>
                <button id="btn-reset" class="btn-reset">é‡ç½®</button>
            </div>
        </div>
    </div>
    
    <ul id="announcement-list" class="announcement-list" aria-live="polite"></ul>
    
    <nav aria-label="åˆ†é å°èˆª">
        <div id="pagination" class="pagination">
            <span class="sr-only">è¼‰å…¥åˆ†é ä¸­...</span>
        </div>
    </nav>
</div>

<div id="detail-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
        <button id="modal-close-btn" class="close-btn" aria-label="é—œé–‰è¦–çª—" title="é—œé–‰">&times;</button>
        <div style="border-bottom: 2px solid #eee; margin-bottom: 1rem; padding-bottom: 0.5rem; padding-right: 30px;">
            <h2 id="modal-title" style="margin:0 0 10px 0; font-weight:normal;">å…¬å‘Šè©³ç´°å…§å®¹</h2>
            <div style="color:#555; font-size: 0.95rem;">
                <span id="modal-dept"></span>
            </div>
            <div id="modal-period" style="color:#777; font-size: 0.9rem; margin-top: 5px;"></div>
        </div>
        <div id="modal-body" class="modal-body"></div>
        
        <div id="modal-links" class="attachments-area" style="display:none; background-color:#eefcfc; border-color:#008080;">
            <h3 title="ç›¸é—œåƒè€ƒé€£çµ"><span aria-hidden="true">ğŸ”—</span> åƒè€ƒç¶²å€ï¼š</h3>
            <ul id="link-list" style="padding-left:1.5rem; margin:0;"></ul>
        </div>

        <div id="modal-attachments" class="attachments-area" style="display:none;">
            <h3 title="é™„ä»¶ä¸‹è¼‰å€åŸŸ"><span aria-hidden="true">ğŸ“</span> é™„ä»¶ä¸‹è¼‰ï¼š</h3>
            <ul id="attachment-list" style="padding-left:1.5rem; margin:0;"></ul>
        </div>
    </div>
</div>

<script>
    // â˜… æ‚¨çš„ GAS ç¶²å€ â˜…
    const DATA_URL = "https://script.google.com/macros/s/AKfycbwpj87uChIU27uvVX_ssWMBRxrreL8OzGp5i3W5GoUdpThqQukqvrpajAsazAM9dC9C/exec";
    const LOCKED_CATEGORY_ID = null; 
    const ITEMS_PER_PAGE = 13; 
    const NEW_DAYS_LIMIT = 4; 

    // SVG
    const SVG_TOP = `<svg aria-hidden="true" class="icon-svg icon-top" viewBox="0 0 24 24" fill="currentColor"><title>ç½®é ‚</title><path d="M16 9V4l1 0c0.55 0 1-0.45 1-1s-0.45-1-1-1H7C6.45 2 6 2.45 6 3s0.45 1 1 1l1 0v5c0 1.66-1.34 3-3 3v2h5.97v7l1 1 1-1v-7H19v-2c-1.66 0-3-1.34-3-3z"></path></svg>`;
    const SVG_NEW = `<svg aria-hidden="true" class="icon-svg icon-new" viewBox="0 0 34 16"><title>æœ€æ–°</title><rect width="34" height="16" rx="3" fill="#d32f2f"/><text x="17" y="12" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-weight="bold" font-size="10">NEW</text></svg>`;

    const CATEGORY_MAP = {
        "2": "è¡Œæ”¿å…¬å‘Š", "28": "è£œåŠ©åŠçåŠ©å­¸é‡‘", "29": "äººäº‹å®¤å…¬å‘Š", "30": "æœƒè¨ˆå®¤å…¬å‘Š",
        "31": "å®¶é•·å°ˆå€", "35": "æ€§åˆ¥å¹³ç­‰", "36": "äººæ¬ŠäºŒå…¬ç´„", "37": "æ ¡å…§å…¬å‘Š",
        "38": "äººå“¡ç”„é¸", "39": "å¹¼å…’åœ’", "48": "é«”è‚²è³½äº‹ã€æ´»å‹•", "156": "æ–°ç”Ÿå ±åˆ°å°ˆå€",
        "168": "å®‰å…¨æ£’çƒ", "7": "ç ”ç¿’å…¬å‘Š", "34": "é˜²ç–«å°ˆå€"
    };

    const CATEGORY_CONFIG = {
        "2": { name: "è¡Œæ”¿å…¬å‘Š", color: "#8B4513" },   
        "28": { name: "è£œåŠ©åŠçåŠ©å­¸é‡‘", color: "#0056b3" }, 
        "29": { name: "äººäº‹å®¤å…¬å‘Š", color: "#800080" }, 
        "30": { name: "ä¸»è¨ˆå®¤å…¬å‘Š", color: "#A0522D" }, 
        "31": { name: "å®¶é•·å°ˆå€", color: "#006666" },   
        "35": { name: "æ€§åˆ¥å¹³ç­‰", color: "#800040" },   
        "36": { name: "äººæ¬ŠäºŒå…¬ç´„", color: "#006400" }, 
        "37": { name: "æ ¡å…§å…¬å‘Š", color: "#0044cc" },   
        "38": { name: "äººå“¡ç”„é¸", color: "#5d4037" },   
        "39": { name: "å¹¼å…’åœ’", color: "#556B2F" },     
        "48": { name: "é«”è‚²è³½äº‹ã€æ´»å‹•", color: "#2F4F4F" }, 
        "156": { name: "æ–°ç”Ÿå ±åˆ°å°ˆå€", color: "#8B4513" }, 
        "168": { name: "å®‰å…¨æ£’çƒ", color: "#4682B4" },  
        "7": { name: "ç ”ç¿’å…¬å‘Š", color: "#800000" },    
        "34": { name: "é˜²ç–«å°ˆå€", color: "#e65100" }    
    };

    const CATEGORY_ORDER = [
        "2", "28", "29", "30", "31", "35", "36", "37", "38", "39", "48", "156", "168", "7"
    ];

    // â˜… å›ºå®šè™•å®¤æ¸…å–® (ç¢ºä¿é¸å–®ä¸€å®šæœ‰é€™äº›) â˜…
    const DEPT_LIST = [
        "æ ¡é•·å®¤", "æ•™å‹™è™•", "å­¸å‹™è™•", "ç¸½å‹™è™•", "è¼”å°è™•", 
        "äººäº‹å®¤", "ä¸»è¨ˆå®¤", "å¹¼å…’åœ’"
    ];

    let allData = [];
    let filteredData = []; 
    let currentPage = 1;
    let currentCategory = 'all';
    let lastFocusedElement = null;

    const listContainer = document.getElementById('announcement-list');
    const loadingDiv = document.getElementById('loading');
    const paginationDiv = document.getElementById('pagination');
    const filterGroup = document.getElementById('filter-group');
    const toolbar = document.getElementById('toolbar');
    
    const toggleSearchBtn = document.getElementById('toggle-search-btn');
    const searchPanel = document.getElementById('search-panel');
    const searchStart = document.getElementById('search-start');
    const searchEnd = document.getElementById('search-end');
    const searchCat = document.getElementById('search-cat');
    const searchDept = document.getElementById('search-dept');
    const searchKeyword = document.getElementById('search-keyword');
    const btnSearch = document.getElementById('btn-search');
    const btnReset = document.getElementById('btn-reset');

    const modal = document.getElementById('detail-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalDept = document.getElementById('modal-dept');
    const modalPeriod = document.getElementById('modal-period');
    const modalBody = document.getElementById('modal-body');
    const modalLinks = document.getElementById('modal-links');
    const linkList = document.getElementById('link-list');
    const modalAttachments = document.getElementById('modal-attachments');
    const attachmentList = document.getElementById('attachment-list');
    const closeBtn = document.getElementById('modal-close-btn');

    function checkIsNew(dateStr) {
        if (!dateStr) return false;
        const parts = dateStr.split(' ')[0].split('.'); 
        if (parts.length !== 3) return false;
        const year = parseInt(parts[0]) + 1911;
        const month = parseInt(parts[1]) - 1; 
        const day = parseInt(parts[2]);
        const postDate = new Date(year, month, day);
        const today = new Date();
        const diffTime = Math.abs(today - postDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        return diffDays <= NEW_DAYS_LIMIT;
    }

    function parseRocDate(rocStr) {
        if (!rocStr) return null;
        const parts = rocStr.split(' ')[0].split('.');
        if (parts.length < 3) return null;
        const year = parseInt(parts[0]) + 1911;
        const month = parseInt(parts[1]) - 1;
        const day = parseInt(parts[2]);
        return new Date(year, month, day);
    }

    fetch(DATA_URL)
        .then(res => res.json())
        .then(json => {
            if (json.status !== "success") throw new Error("GAS Error");
            loadingDiv.style.display = 'none';
            if (!json.data || json.data.length === 0) {
                listContainer.innerHTML = "<li style='padding:10px; color:#666;'>ç›®å‰æ²’æœ‰å…¬å‘Šã€‚</li>";
                return;
            }
            allData = json.data;
            
            if (LOCKED_CATEGORY_ID) {
                toolbar.style.display = 'none'; 
                searchPanel.style.display = 'none';
                applyFilter(LOCKED_CATEGORY_ID);
            } else {
                initFilters();
                initSearchOptions(); 
                filteredData = allData;
                renderPage(1);
            }
        })
        .catch(err => {
            console.error(err);
            loadingDiv.innerHTML = `<span style="color:red; font-size:0.9rem;">è³‡æ–™è¼‰å…¥å¤±æ•— (è«‹ç¢ºèª GAS æ˜¯å¦å·²éƒ¨ç½²æ–°ç‰ˆæœ¬)</span>`;
        });

    function initFilters() {
        const counts = {};
        allData.forEach(item => {
            if (item.category_ids && Array.isArray(item.category_ids)) {
                item.category_ids.forEach(catId => {
                     counts[catId] = (counts[catId] || 0) + 1;
                });
            }
        });

        filterGroup.innerHTML = "";
        createFilterBtn("all", counts["all"] || allData.length);

        CATEGORY_ORDER.forEach(catId => {
            if (CATEGORY_MAP[catId]) {
                const name = CATEGORY_MAP[catId];
                const count = counts[catId] || 0;
                createFilterBtn(catId, count);
            }
        });
    }

    function initSearchOptions() {
        // å›ºå®šè™•å®¤æ¸…å–® + å‹•æ…‹è£œå……
        const deptSelect = document.getElementById('search-dept');
        const catSelect = document.getElementById('search-cat');
        
        const depts = new Set(DEPT_LIST);
        allData.forEach(item => {
            if (item.department) depts.add(item.department);
        });

        deptSelect.innerHTML = '<option value="">å…¨éƒ¨è™•å®¤</option>';
        Array.from(depts).forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            deptSelect.appendChild(opt);
        });

        catSelect.innerHTML = '<option value="">å…¨éƒ¨é¡åˆ¥</option>';
        CATEGORY_ORDER.forEach(catId => {
            if (CATEGORY_MAP[catId]) {
                const opt = document.createElement('option');
                opt.value = catId;
                opt.textContent = CATEGORY_MAP[catId];
                catSelect.appendChild(opt);
            }
        });
    }

    function createFilterBtn(catId, count) {
        let config;
        if (catId === 'all') {
            config = { name: "å…¨éƒ¨å…¬å‘Š", color: "#333333" };
        } else {
            config = CATEGORY_CONFIG[catId] || { name: "å…¶ä»–", color: "#999" };
        }

        const btn = document.createElement('button');
        btn.className = `filter-btn ${catId === 'all' ? 'active' : ''}`;
        btn.style.setProperty('--btn-color', config.color);
        btn.dataset.cat = catId;
        
        // â˜… ä¿®æ”¹ï¼štitle åŠ å…¥æ•¸é‡æç¤º (AAA) â˜…
        btn.title = `ç¯©é¸åˆ†é¡ï¼š${config.name}ï¼Œå…± ${count} å‰‡`;
        
        btn.innerHTML = `${config.name} <span class="count-badge">${count}</span>`;
        
        btn.addEventListener('click', () => {
            searchPanel.style.display = 'none';
            toggleSearchBtn.setAttribute('aria-expanded', 'false'); 
            applyFilter(catId);
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
        filterGroup.appendChild(btn);
    }

    function applyFilter(category) {
        currentCategory = category;
        if (category === 'all') {
            filteredData = allData;
        } else {
            filteredData = allData.filter(item => {
                return item.category_ids && item.category_ids.includes(category);
            });
        }
        currentPage = 1;
        renderPage(1);
    }

    function performSearch() {
        const sDate = searchStart.value ? new Date(searchStart.value) : null;
        const eDate = searchEnd.value ? new Date(searchEnd.value) : null;
        const cat = searchCat.value;
        const dept = searchDept.value;
        const keyword = searchKeyword.value.trim().toLowerCase();

        filteredData = allData.filter(item => {
            let match = true;

            if (sDate || eDate) {
                const itemDate = parseRocDate(item.date);
                if (itemDate) {
                    if (sDate && itemDate < sDate) match = false;
                    if (eDate && itemDate > eDate) match = false;
                }
            }
            if (match && cat) {
                if (!item.category_ids || !item.category_ids.includes(cat)) match = false;
            }
            if (match && dept) {
                if (item.department !== dept) match = false;
            }
            if (match && keyword) {
                if (!item.title.toLowerCase().includes(keyword)) match = false;
            }
            return match;
        });

        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        renderPage(1);
    }

    toggleSearchBtn.addEventListener('click', () => {
        const isHidden = searchPanel.style.display === 'none' || searchPanel.style.display === '';
        if (isHidden) {
            searchPanel.style.display = 'block';
            toggleSearchBtn.setAttribute('aria-expanded', 'true');
        } else {
            searchPanel.style.display = 'none';
            toggleSearchBtn.setAttribute('aria-expanded', 'false');
        }
    });

    btnSearch.addEventListener('click', performSearch);
    
    btnReset.addEventListener('click', () => {
        searchStart.value = '';
        searchEnd.value = '';
        searchCat.value = '';
        searchDept.value = '';
        searchKeyword.value = '';
        applyFilter('all');
        document.querySelector('[data-cat="all"]').classList.add('active');
    });

    function renderPage(page) {
        currentPage = page;
        listContainer.innerHTML = "";
        
        if (filteredData.length === 0) {
            const emptyMsg = LOCKED_CATEGORY_ID ? "ç›®å‰å°šç„¡æ­¤å°ˆå€çš„å…¬å‘Šã€‚" : "æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„å…¬å‘Šã€‚";
            listContainer.innerHTML = `<li style='padding:20px; text-align:center; color:#666;'>${emptyMsg}</li>`;
            paginationDiv.innerHTML = "";
            return;
        }
        
        const start = (page - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const pageItems = filteredData.slice(start, end);

        pageItems.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'list-item';
            const simpleDate = item.date ? item.date.split(' ')[0] : '-';
            
            let tagsHtml = '';
            if (item.category_ids && Array.isArray(item.category_ids) && item.category_ids.length > 0) {
                item.category_ids.forEach((id, i) => {
                    const catConfig = CATEGORY_CONFIG[id];
                    if (catConfig) {
                        tagsHtml += `<span class="tag-badge" style="background-color:${catConfig.color}; color:#fff;" title="åˆ†é¡ï¼š${catConfig.name}"><span class="sr-only">åˆ†é¡ï¼š</span>${catConfig.name}</span>`;
                    }
                });
            }
            if (!tagsHtml) {
                tagsHtml = `<span class="tag-badge tag-dept" title="ç™¼å¸ƒå–®ä½ï¼š${item.department}"><span class="sr-only">ç™¼å¸ƒå–®ä½ï¼š</span>${item.department}</span>`;
            }

            let topHtml = "";
            if (item.is_top == 1 || item.is_top === "1") {
                topHtml = SVG_TOP;
            }
            let newHtml = "";
            if (checkIsNew(item.date)) {
                newHtml = SVG_NEW;
            }

            let titleActionHtml = "";
            let loginBadgeHtml = "";

            if (item.pub_view == "2") {
                titleActionHtml = `
                    <a href="https://esa.ntpc.edu.tw" target="_blank" class="title-btn" title="éœ€ç™»å…¥ç³»çµ±è§€çœ‹ï¼š${item.title}">
                        ${topHtml}${item.title}${newHtml}
                    </a>`;
                loginBadgeHtml = `<a href="https://esa.ntpc.edu.tw" target="_blank" class="login-badge" title="éœ€ç™»å…¥ç³»çµ±è§€çœ‹">é ˆç™»å…¥ç³»çµ±</a>`;
            } else {
                titleActionHtml = `
                    <button class="title-btn" onclick="openDetails(${start + index})" title="æŸ¥çœ‹å…¬å‘Šï¼š${item.title}">
                        ${topHtml}${item.title}${newHtml}
                    </button>`;
            }

            li.innerHTML = `
                <div class="list-date" title="ç™¼å¸ƒæ—¥æœŸï¼š${simpleDate}"><span class="sr-only">ç™¼å¸ƒæ—¥æœŸï¼š</span>${simpleDate}</div>
                <div class="list-tags">
                    ${tagsHtml}
                </div>
                <div class="list-title">
                    ${titleActionHtml}
                    ${loginBadgeHtml}
                </div>
            `;
            listContainer.appendChild(li);
        });

        renderPagination();
    }

    function renderPagination() {
        paginationDiv.innerHTML = "";
        const totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
        
        if (totalPages <= 1) return;

        const pagesPerGroup = 10;
        const currentGroup = Math.ceil(currentPage / pagesPerGroup);
        const startPage = (currentGroup - 1) * pagesPerGroup + 1;
        const endPage = Math.min(startPage + pagesPerGroup - 1, totalPages);

        if (startPage > 1) {
             const prevGroupBtn = document.createElement('button');
             prevGroupBtn.className = 'page-btn';
             prevGroupBtn.innerText = "<<"; 
             prevGroupBtn.title = "ä¸Š10é ";
             prevGroupBtn.setAttribute('aria-label', 'ä¸Š10é ');
             prevGroupBtn.onclick = () => renderPage(startPage - 1); 
             paginationDiv.appendChild(prevGroupBtn);
        }

        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.innerText = "<";
        prevBtn.title = "ä¸Šä¸€é ";
        prevBtn.disabled = currentPage === 1;
        prevBtn.setAttribute('aria-label', 'ä¸Šä¸€é ');
        prevBtn.onclick = () => renderPage(currentPage - 1);
        paginationDiv.appendChild(prevBtn);

        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            btn.innerText = i;
            btn.title = `å‰å¾€ç¬¬ ${i} é `;
            btn.setAttribute('aria-label', `ç¬¬ ${i} é `);
            if(i === currentPage) btn.setAttribute('aria-current', 'page');
            btn.onclick = () => renderPage(i);
            paginationDiv.appendChild(btn);
        }

        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.innerText = ">";
        nextBtn.title = "ä¸‹ä¸€é ";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.setAttribute('aria-label', 'ä¸‹ä¸€é ');
        nextBtn.onclick = () => renderPage(currentPage + 1);
        paginationDiv.appendChild(nextBtn);

        if (endPage < totalPages) {
             const nextGroupBtn = document.createElement('button');
             nextGroupBtn.className = 'page-btn';
             nextGroupBtn.innerText = ">>"; 
             nextGroupBtn.title = "ä¸‹10é ";
             nextGroupBtn.setAttribute('aria-label', 'ä¸‹10é ');
             nextGroupBtn.onclick = () => renderPage(endPage + 1); 
             paginationDiv.appendChild(nextGroupBtn);
        }
    }

    window.openDetails = function(index) {
        const item = filteredData[index];
        lastFocusedElement = document.activeElement;
        
        if(modalTitle) {
            modalTitle.textContent = item.title;
            modalTitle.setAttribute('title', `å…¬å‘Šæ¨™é¡Œï¼š${item.title}`);
        }
        
        if(modalDept) {
            const fullDept = item.job_title ? `${item.department} / ${item.job_title}` : item.department;
            modalDept.innerHTML = `<span class="sr-only">ç™¼å¸ƒå–®ä½ï¼š</span>${fullDept}`;
        }
        
        if(modalPeriod) {
            if (item.date_start && item.date_end) {
                modalPeriod.innerHTML = `å…¬å‘ŠæœŸé–“ï¼š${item.date_start} ~ ${item.date_end}`;
            } else {
                modalPeriod.innerHTML = "";
            }
        }
        
        if(modalBody) modalBody.innerHTML = item.content_html;
        
        if (modalLinks) {
            if (item.link_a || item.link_b) {
                modalLinks.style.display = 'block';
                let linksHtml = '';
                if (item.link_a) {
                    linksHtml += `<li><a href="${item.link_a}" target="_blank" title="åƒè€ƒç¶²å€1ï¼š${item.link_a}">åƒè€ƒç¶²å€1</a></li>`;
                }
                if (item.link_b) {
                    linksHtml += `<li><a href="${item.link_b}" target="_blank" title="åƒè€ƒç¶²å€2ï¼š${item.link_b}">åƒè€ƒç¶²å€2</a></li>`;
                }
                if(linkList) linkList.innerHTML = linksHtml;
            } else {
                modalLinks.style.display = 'none';
            }
        }

        if (item.attachments && item.attachments.length > 0) {
            if(modalAttachments) modalAttachments.style.display = 'block';
            if(attachmentList) {
                attachmentList.innerHTML = item.attachments.map(f => `
                    <li><a href="${f.url}" target="_blank" title="ä¸‹è¼‰é™„ä»¶ï¼š${f.name}">ä¸‹è¼‰ï¼š${f.name}</a></li>
                `).join('');
            }
        } else {
            if(modalAttachments) modalAttachments.style.display = 'none';
        }
        
        modal.style.display = 'flex';
        closeBtn.focus();
        document.body.style.overflow = 'hidden';
    };

    function closeModal() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        if (lastFocusedElement) lastFocusedElement.focus();
    }

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.style.display === 'flex') closeModal(); });

</script>

</body>
</html>